import logging
import random
import requests
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes, MessageHandler, filters

# === ğŸ” Ø§Ù„Ù…ÙØ§ØªÙŠØ­ (ÙŠØªÙ… Ø¬Ù„Ø¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ø¨ÙŠØ¦Ø© - Ù…Ø«Ù„ Replit Ø£Ùˆ Render) ===
import os

BOT_TOKEN = os.getenv("BOT_TOKEN")
TMDB_API_KEY = os.getenv("TMDB_API_KEY")

# === ğŸ“¢ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ===
if not BOT_TOKEN:
    print("âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† BOT_TOKEN")
    exit()
if not TMDB_API_KEY:
    print("âŒ ØªØ­Ø°ÙŠØ±: Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† TMDB_API_KEY")
    exit()

print("âœ… Ø§Ù„Ø¨ÙˆØª Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ´ØºÙŠÙ„...")
print("ğŸ“¡ ÙŠØ³ØªØ®Ø¯Ù… ØªÙˆÙƒÙ† Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…: ", BOT_TOKEN[:10] + "...")
print("ğŸ¬ ÙŠØ³ØªØ®Ø¯Ù… Ù…ÙØªØ§Ø­ TMDb: ", TMDB_API_KEY[:10] + "...")

# === ğŸŒ Ø§Ù„Ù†ØµÙˆØµ Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù„ØºØ§Øª ===
TEXTS = {
    'start': {
        'ar': "Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø£Ù†Ø§ *What To Watch* ğŸ¥\nØ§Ø®ØªØ± Ù„ØºØªÙƒ:",
        'en': "Hi! I'm *What To Watch* ğŸ¥\nChoose your language:"
    },
    'lang_selected': {
        'ar': "âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
        'en': "âœ… English selected"
    },
    'choose': {
        'ar': "Ø§Ø®ØªØ± Ù…Ø§ ØªØ±ÙŠØ¯:",
        'en': "Choose what you want:"
    },
    'origin': {
        'ar': "Ø§Ø®ØªØ± *Ø£ØµÙ„ Ø§Ù„ÙÙŠÙ„Ù…*:",
        'en': "Choose *Movie Origin*:"
    },
    'language': {
        'ar': "Ø§Ø®ØªØ± *Ù„ØºØ© Ø§Ù„ÙÙŠÙ„Ù…*:",
        'en': "Choose *Movie Language*:"
    },
    'rating_step': {
        'ar': "Ø§Ø®ØªØ± *Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ù†Ù‰* Ù„Ù„ÙÙŠÙ„Ù… (Ù…Ù† 1 Ø¥Ù„Ù‰ 10):",
        'en': "Choose *minimum rating* for the movie (from 1 to 10):"
    },
    'genre': {
        'ar': "Ø§Ø®ØªØ± *Ù†ÙˆØ¹ Ø§Ù„ÙÙŠÙ„Ù…*:",
        'en': "Choose *Genre*:"
    },
    'movie_info': {
        'ar': (
            "ğŸ¬ *{title}*\n"
            "ğŸŒ Ø§Ù„Ø£ØµÙ„: {origin}\n"
            "ğŸ—£ Ø§Ù„Ù„ØºØ©: {lang}\n"
            "ğŸ­ Ø§Ù„Ù†ÙˆØ¹: {genre}\n"
            "ğŸ“… Ø§Ù„Ø³Ù†Ø©: {year}\n"
            "â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: {rating}/10\n"
            "ğŸ“ {overview}\n"
            "ğŸ”— [IMDb](https://www.imdb.com/title/{imdb_id}/)"
        ),
        'en': (
            "ğŸ¬ *{title}*\n"
            "ğŸŒ Origin: {origin}\n"
            "ğŸ—£ Language: {lang}\n"
            "ğŸ­ Genre: {genre}\n"
            "ğŸ“… Year: {year}\n"
            "â­ Rating: {rating}/10\n"
            "ğŸ“ {overview}\n"
            "ğŸ”— [IMDb](https://www.imdb.com/title/{imdb_id}/)"
        )
    },
    'start_filter': {
        'ar': "ğŸ¬ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±",
        'en': "ğŸ¬ Start Choosing"
    },
    'random': {
        'ar': "ğŸ² ÙÙŠÙ„Ù… Ø¹Ø´ÙˆØ§Ø¦ÙŠ",
        'en': "ğŸ² Random Movie"
    }
}

# === ğŸï¸ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ===
ORIGINS = {
    'ar': ["Ù‡ÙˆÙ„ÙŠÙˆÙˆØ¯", "Ø¨ÙˆÙ„ÙŠÙˆÙˆØ¯", "Ø¹Ø±Ø¨ÙŠ", "Ø¢Ø³ÙŠÙˆÙŠ", "ÙØ±Ù†Ø³ÙŠ", "Ø¥Ø³Ø¨Ø§Ù†ÙŠ"],
    'en': ["Hollywood", "Bollywood", "Arabic", "Asian", "French", "Spanish"]
}

LANGUAGES = {
    'ar': ["Ø¹Ø±Ø¨ÙŠ", "Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ", "Ù‡Ù†Ø¯ÙŠ", "ÙƒÙˆØ±ÙŠ", "ÙŠØ§Ø¨Ø§Ù†ÙŠ", "ÙØ±Ù†Ø³ÙŠ"],
    'en': ["Arabic", "English", "Hindi", "Korean", "Japanese", "French"]
}

# Ø®Ø±ÙŠØ·Ø© Ù„ØºØ§Øª TMDb
LANGUAGE_CODES = {
    'Ø¹Ø±Ø¨ÙŠ': 'ar', 'Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ': 'en', 'Ù‡Ù†Ø¯ÙŠ': 'hi', 'ÙƒÙˆØ±ÙŠ': 'ko', 'ÙŠØ§Ø¨Ø§Ù†ÙŠ': 'ja', 'ÙØ±Ù†Ø³ÙŠ': 'fr',
    'Arabic': 'ar', 'English': 'en', 'Hindi': 'hi', 'Korean': 'ko', 'Japanese': 'ja', 'French': 'fr'
}

GENRES = {
    'ar': ["Ø£ÙƒØ´Ù†", "Ø¯Ø±Ø§Ù…Ø§", "ÙƒÙˆÙ…ÙŠØ¯ÙŠØ§", "Ø±Ø¹Ø¨", "Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠ", "Ø®ÙŠØ§Ù„ Ø¹Ù„Ù…ÙŠ", "Ø¬Ø±ÙŠÙ…Ø©", "Ø£Ù†Ù…ÙŠØ´Ù†"],
    'en': ["Action", "Drama", "Comedy", "Horror", "Romance", "Sci-Fi", "Crime", "Animation"]
}

# Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
GENRE_IDS = {
    'Ø£ÙƒØ´Ù†': 28, 'Ø¯Ø±Ø§Ù…Ø§': 18, 'ÙƒÙˆÙ…ÙŠØ¯ÙŠØ§': 35, 'Ø±Ø¹Ø¨': 27, 'Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠ': 10749,
    'Ø®ÙŠØ§Ù„ Ø¹Ù„Ù…ÙŠ': 878, 'Ø¬Ø±ÙŠÙ…Ø©': 80, 'Ø£Ù†Ù…ÙŠØ´Ù†': 16,
    'Action': 28, 'Drama': 18, 'Comedy': 35, 'Horror': 27, 'Romance': 10749,
    'Sci-Fi': 878, 'Crime': 80, 'Animation': 16
}

# === ğŸŒ Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ ÙÙŠÙ„Ù… Ù…Ù† TMDb Ù…Ø¹ ØªØµÙÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„ØºØ© ÙˆØ§Ù„Ø£ØµÙ„ ===
def get_movie_from_tmdb(origin=None, language=None, genre=None, min_rating=0, user_lang='en'):
    url = "https://api.themoviedb.org/3/discover/movie"
    params = {
        'api_key': TMDB_API_KEY,
        'sort_by': 'popularity.desc',
        'vote_count.gte': 100,
        'page': random.randint(1, 5)
    }

    # âœ… ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ù„ØºØ© Ø§Ù„ÙÙŠÙ„Ù…
    if language in LANGUAGE_CODES:
        params['with_original_language'] = LANGUAGE_CODES[language]

    # âœ… ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    if genre in GENRE_IDS:
        params['with_genres'] = GENRE_IDS[genre]

    # âœ… ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ù†Ù‰
    if min_rating > 0:
        params['vote_average.gte'] = min_rating

    try:
        response = requests.get(url, params=params, timeout=10)
        if response.status_code == 200:
            data = response.json()
            if data.get('results'):
                candidates = []

                for movie_data in data['results']:
                    # âœ… Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©: Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± "Ø¹Ø±Ø¨ÙŠ"ØŒ ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù„ØºØ© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù‡ÙŠ 'ar'
                    if origin == "Ø¹Ø±Ø¨ÙŠ" or language == "Ø¹Ø±Ø¨ÙŠ":
                        if movie_data.get('original_language') != 'ar':
                            continue  # ØªØ®Ø·ÙŠ Ø§Ù„Ø£ÙÙ„Ø§Ù… ØºÙŠØ± Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©

                    # âœ… ØªØµÙÙŠØ© Ù‡Ù†Ø¯ÙŠØ©: Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± "Ù‡Ù†Ø¯ÙŠ"ØŒ ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù„ØºØ© 'hi'
                    if language == "Ù‡Ù†Ø¯ÙŠ" and movie_data.get('original_language') != 'hi':
                        continue

                    # âœ… ØªØµÙÙŠØ© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©: Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± "Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ"ØŒ ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù„ØºØ© 'en'
                    if language == "Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ" and movie_data.get('original_language') != 'en':
                        continue

                    candidates.append(movie_data)

                if candidates:
                    movie_data = random.choice(candidates)

                    # âœ… Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¨Ù„ØºØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    lang_code = 'ar' if user_lang == 'ar' else 'en'
                    details_url = f"https://api.themoviedb.org/3/movie/{movie_data['id']}"
                    details_params = {
                        'api_key': TMDB_API_KEY,
                        'language': lang_code
                    }
                    details = requests.get(details_url, params=details_params).json()

                    # âœ… Ø§Ø³Ù… Ø§Ù„ÙÙŠÙ„Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¯Ø§Ø¦Ù…Ù‹Ø§
                    title = movie_data.get('original_title') or movie_data.get('title', 'Unknown Title')
                    overview = details.get('overview') or "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­."

                    return {
                        'title': title,
                        'year': movie_data['release_date'][:4] if movie_data.get('release_date') else "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
                        'rating': round(movie_data['vote_average'], 1),
                        'overview': overview,
                        'imdb_id': details.get('imdb_id', 'tt0000000'),
                        'origin': origin or "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
                        'lang': language or "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
                        'genre': genre or "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"
                    }
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ TMDb: {e}")

    # Ø£ÙÙ„Ø§Ù… Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (Ù†Ø§Ø¯Ø±Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…)
    fallback = [
        {"title": "Inception", "genre": "Ø®ÙŠØ§Ù„ Ø¹Ù„Ù…ÙŠ", "origin": "Ù‡ÙˆÙ„ÙŠÙˆÙˆØ¯", "language": "Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ", "year": 2010, "rating": 8.8, "imdb_id": "tt1375666", "overview": "A dream within a dream"},
        {"title": "The Blue Elephant", "genre": "Ø±Ø¹Ø¨", "origin": "Ø¹Ø±Ø¨ÙŠ", "language": "Ø¹Ø±Ø¨ÙŠ", "year": 2014, "rating": 7.8, "imdb_id": "tt4599282", "overview": "ÙÙŠÙ„Ù… Ø±Ø¹Ø¨ Ù…ØµØ±ÙŠ Ù†ÙØ³ÙŠ"}
    ]
    movie = random.choice(fallback)
    return {
        'title': movie['title'],
        'year': movie['year'],
        'rating': movie['rating'],
        'overview': movie['overview'],
        'imdb_id': movie['imdb_id'],
        'origin': movie['origin'],
        'lang': movie['language'],
        'genre': movie['genre']
    }

# === ğŸ¤– Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª ===
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ğŸ‡¾ğŸ‡ª", callback_data='lang_ar')],
        [InlineKeyboardButton("English ğŸ‡¬ğŸ‡§", callback_data='lang_en')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(
        TEXTS['start']['ar'],
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data
    lang = context.user_data.get('lang', 'ar')

    if data == 'lang_ar':
        context.user_data['lang'] = 'ar'
        await query.edit_message_text(TEXTS['lang_selected']['ar'])
        await show_main_menu(query, 'ar')
    elif data == 'lang_en':
        context.user_data['lang'] = 'en'
        await query.edit_message_text(TEXTS['lang_selected']['en'])
        await show_main_menu(query, 'en')

    elif data == 'start_filter':
        keyboard = [[InlineKeyboardButton(o, callback_data=f'origin_{o}')] for o in ORIGINS[lang]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(TEXTS['origin'][lang], reply_markup=reply_markup, parse_mode='Markdown')

    elif data.startswith('origin_'):
        origin = data.split('_', 1)[1]
        context.user_data['origin'] = origin
        keyboard = [[InlineKeyboardButton(l, callback_data=f'lang_{l}')] for l in LANGUAGES[lang]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(TEXTS['language'][lang], reply_markup=reply_markup, parse_mode='Markdown')

    elif data.startswith('lang_') and not data.startswith('lang_a'):
        language = data.split('_', 1)[1]
        context.user_data['movie_lang'] = language
        await ask_for_min_rating(query, lang)

    elif data.startswith('genre_'):
        genre = data.split('_', 1)[1]
        context.user_data['genre'] = genre
        await suggest_movie_with_filters(query, lang, context)

    elif data == 'random':
        movie = get_movie_from_tmdb(user_lang=lang)
        context.user_data['last_movie'] = movie
        await send_movie(query, movie, lang)

# === â­ Ø®Ø·ÙˆØ©: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ù†Ù‰ ===
async def ask_for_min_rating(query, lang):
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton(str(i), callback_data=f'minrate_{i}') for i in range(1, 6)],
        [InlineKeyboardButton(str(i), callback_data=f'minrate_{i}') for i in range(6, 11)]
    ])
    await query.edit_message_text(TEXTS['rating_step'][lang], reply_markup=keyboard, parse_mode='Markdown')

# === ğŸ¯ Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†ÙˆØ¹ ===
async def handle_min_rating(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    rating = int(query.data.split('_')[1])
    context.user_data['min_rating'] = rating
    lang = context.user_data.get('lang', 'ar')

    keyboard = [[InlineKeyboardButton(g, callback_data=f'genre_{g}')] for g in GENRES[lang]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(TEXTS['genre'][lang], reply_markup=reply_markup, parse_mode='Markdown')

# === ğŸ¬ Ø§Ù‚ØªØ±Ø§Ø­ ÙÙŠÙ„Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØµÙÙŠØ© (Ù…Ø¹ Ø§Ù„ØªØµØ­ÙŠØ­) ===
async def suggest_movie_with_filters(query, lang, context):
    origin = context.user_data.get('origin')
    language = context.user_data.get('movie_lang')
    genre = context.user_data.get('genre')
    min_rating = context.user_data.get('min_rating', 0)

    movie = get_movie_from_tmdb(
        origin=origin,
        language=language,
        genre=genre,
        min_rating=min_rating,
        user_lang=lang
    )

    if not movie:
        await query.edit_message_text("âŒ Ù„Ù… Ø£Ø¬Ø¯ ÙÙŠÙ„Ù…Ù‹Ø§ ÙŠÙ†Ø§Ø³Ø¨ Ù…Ø¹Ø§ÙŠÙŠØ±Ùƒ.")
        return

    context.user_data['last_movie'] = movie
    await send_movie(query, movie, lang)

async def show_main_menu(query, lang):
    keyboard = [
        [InlineKeyboardButton(TEXTS['start_filter'][lang], callback_data='start_filter')],
        [InlineKeyboardButton(TEXTS['random'][lang], callback_data='random')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.message.reply_text(TEXTS['choose'][lang], reply_markup=reply_markup, parse_mode='Markdown')

# === ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠÙ„Ù… Ø§Ù„Ù…Ù‚ØªØ±Ø­ (Ø¨Ø¯ÙˆÙ† Ø£Ø²Ø±Ø§Ø±) ===
async def send_movie(query, movie, lang):
    text = TEXTS['movie_info'][lang].format(
        title=movie['title'],  # âœ… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¯Ø§Ø¦Ù…Ù‹Ø§
        origin=movie['origin'],
        lang=movie['lang'],
        genre=movie['genre'],
        year=movie['year'],
        rating=movie['rating'],
        overview=movie['overview'],
        imdb_id=movie['imdb_id']
    )
    await query.edit_message_text(text=text, parse_mode='Markdown', disable_web_page_preview=True)

# === Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ© ===
async def message_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text.lower()
    lang = context.user_data.get('lang', 'ar')
    if any(word in text for word in ['ÙÙŠÙ„Ù…', 'watch', 'movie']):
        movie = get_movie_from_tmdb(user_lang=lang)
        await update.message.reply_text(f"ğŸ¬ {movie['title']} (â­ {movie['rating']})", parse_mode='Markdown')

# === ğŸš€ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ===
def main():
    if not BOT_TOKEN:
        print("âŒ BOT_TOKEN Ù…Ø·Ù„ÙˆØ¨")
        return

    application = Application.builder().token(BOT_TOKEN).build()

    # âœ… Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
    application.add_handler(CallbackQueryHandler(handle_min_rating, pattern='^minrate_'))
    application.add_handler(CallbackQueryHandler(button_handler))
    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, message_handler))

    print("âœ… Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„: What To Watch (Ù…ÙØ­Ø¯Ù‘Ø«) - ØªØµÙÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø©")
    application.run_polling()

if __name__ == '__main__':
    main()
